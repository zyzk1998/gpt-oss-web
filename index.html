<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galaxy ç”Ÿä¿¡æ™ºèƒ½åŠ©æ‰‹</title>
    <!-- å¼•å…¥ Bootstrap å’Œ Marked -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { background-color: #f4f6f9; height: 100vh; display: flex; flex-direction: column; }
        /* èŠå¤©åŒºåŸŸ */
        .chat-container { flex: 1; overflow-y: auto; padding: 20px; max-width: 900px; margin: 0 auto; width: 100%; }
        
        /* æ¶ˆæ¯æ°”æ³¡ */
        .message { margin-bottom: 20px; padding: 15px; border-radius: 10px; max-width: 85%; word-wrap: break-word; }
        .message.user { background-color: #007bff; color: white; align-self: flex-end; margin-left: auto; }
        .message.system { background-color: white; border: 1px solid #ddd; align-self: flex-start; }
        
        /* å·¥å…·å¡ç‰‡ */
        .tool-card { 
            border: 1px solid #17a2b8; background: #e3f2fd; 
            padding: 10px; margin: 5px 0; border-radius: 5px; 
            cursor: pointer; transition: 0.2s; 
        }
        .tool-card:hover { background: #d1ecf1; transform: translateX(5px); }
        
        /* åº•éƒ¨è¾“å…¥åŒº */
        .input-area { background: white; padding: 20px; border-top: 1px solid #ddd; }
        .input-group { max-width: 900px; margin: 0 auto; }
        
        /* çŠ¶æ€æ ‡ç­¾ */
        .status-badge { font-size: 0.85em; padding: 5px 10px; border-radius: 15px; display: none; margin-top: 5px; }
        .badge-file { background-color: #28a745; color: white; }
        
        /* ä»£ç å—æ ·å¼ */
        pre { background: #2d2d2d; color: #f8f8f2; padding: 10px; border-radius: 5px; overflow-x: auto; }
    </style>
</head>
<body>

    <!-- é¡¶éƒ¨å¯¼èˆªï¼šå»æŠ€æœ¯åŒ–æ–‡æ¡ˆ -->
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid justify-content-center">
            <span class="navbar-brand mb-0 h1">ğŸ§¬ Galaxy ç”Ÿä¿¡åˆ†ææ™ºèƒ½åŠ©æ‰‹</span>
        </div>
    </nav>

    <!-- èŠå¤©è®°å½• -->
    <div class="chat-container d-flex flex-column" id="chatBox">
        <div class="message system">
            ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ç”Ÿç‰©ä¿¡æ¯å­¦åŠ©æ‰‹ã€‚<br>
            æˆ‘å¯ä»¥å¸®ä½ ï¼š<br>
            1. <b>æŸ¥è¯¢ç³»ç»Ÿä¿¡æ¯</b> (å¦‚â€œæˆ‘çš„å†å²è®°å½•â€)<br>
            2. <b>æ‰§è¡Œåˆ†æå·¥å…·</b> (å¦‚â€œåšè´¨æ§â€ã€â€œæ¯”å¯¹åºåˆ—â€)<br>
            3. <b>è¯†åˆ«å›¾ç‰‡å†…å®¹</b> (ç›´æ¥ä¸Šä¼ æˆªå›¾å³å¯)
        </div>
    </div>

    <!-- è¾“å…¥åŒºåŸŸ -->
    <div class="input-area">
        <div class="input-group">
            <!-- éšè—çš„æ–‡ä»¶è¾“å…¥æ¡† -->
            <input type="file" id="fileInput" style="display: none;" onchange="handleFileUpload()">
            
            <!-- ä¸Šä¼ æŒ‰é’® -->
            <button class="btn btn-outline-secondary" onclick="document.getElementById('fileInput').click()" title="ä¸Šä¼ å›¾ç‰‡æˆ–æ•°æ®">
                ğŸ“
            </button>
            
            <!-- æ–‡æœ¬è¾“å…¥ -->
            <input type="text" id="userInput" class="form-control" placeholder="è¯·è¾“å…¥æ‚¨çš„éœ€æ±‚..." onkeypress="handleEnter(event)">
            
            <!-- å‘é€æŒ‰é’® -->
            <button class="btn btn-primary" onclick="sendMessage()" id="sendBtn">å‘é€</button>
        </div>
        
        <!-- æ–‡ä»¶çŠ¶æ€æ˜¾ç¤º -->
        <div class="d-flex justify-content-center">
            <span id="fileStatus" class="status-badge badge-file"></span>
        </div>
    </div>

    <script>
        const chatBox = document.getElementById('chatBox');
        const userInput = document.getElementById('userInput');
        
        // å­˜å‚¨å¯¹è¯å†å² (ç”¨äºå‘é€ç»™åç«¯ï¼Œå®ç°çŸ­æœŸè®°å¿†)
        let chatHistory = []; 
        let currentUploadedFile = { id: null, name: null };

        function handleEnter(e) { if (e.key === 'Enter') sendMessage(); }

        // --- 1. æ–‡ä»¶ä¸Šä¼ å¤„ç† ---
        async function handleFileUpload() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            if (!file) return;

            appendMessage('user', `æ­£åœ¨å¤„ç†æ–‡ä»¶: ${file.name} ...`);
            
            const formData = new FormData();
            formData.append('file', file);

            try {
                const res = await fetch('/api/upload', { method: 'POST', body: formData });
                const data = await res.json();
                
                if (data.status === 'success') {
                    // æƒ…å†µ A: å›¾ç‰‡ OCR
                    if (data.type === 'image') {
                        appendMessage('system', `ğŸ‘ï¸ <b>å›¾ç‰‡è¯†åˆ«ç»“æœï¼š</b><br><blockquote>${data.ocr_text}</blockquote>`);
                        // è®°å½•åˆ°å†å²ï¼Œæ–¹ä¾¿åç»­è¿½é—®
                        chatHistory.push({ user: "[ä¸Šä¼ äº†å›¾ç‰‡]", ai: data.ocr_text });
                        
                        // è‡ªåŠ¨å¡«å……åˆ°è¾“å…¥æ¡†
                        userInput.value = `è¯·è§£é‡Šè¿™å¼ å›¾ç‰‡çš„å†…å®¹`;
                    } 
                    // æƒ…å†µ B: æ•°æ®æ–‡ä»¶
                    else {
                        currentUploadedFile = { id: data.file_id, name: data.file_name };
                        appendMessage('system', `âœ… æ•°æ®å·²ä¸Šä¼ åˆ° Galaxy (ID: ${data.file_id})`);
                        
                        const badge = document.getElementById('fileStatus');
                        badge.style.display = 'inline-block';
                        badge.innerText = `ğŸ“„ å·²å°±ç»ª: ${data.file_name}`;
                        
                        chatHistory.push({ user: "[ä¸Šä¼ äº†æ–‡ä»¶]", ai: `æ–‡ä»¶ ${data.file_name} ä¸Šä¼ æˆåŠŸ` });
                    }
                } else {
                    appendMessage('system', `âŒ å¤„ç†å¤±è´¥: ${data.message}`);
                }
            } catch (e) {
                appendMessage('system', `âŒ ç½‘ç»œé”™è¯¯: ${e}`);
            }
            // æ¸…ç©º input é˜²æ­¢é‡å¤ä¸Šä¼ åŒä¸€æ–‡ä»¶ä¸è§¦å‘ onchange
            fileInput.value = '';
        }

        // --- 2. å‘é€æ¶ˆæ¯ (ä¸»é€»è¾‘) ---
        async function sendMessage(selectedTool = null, originalQuery = null) {
            let text = userInput.value.trim();
            
            // å¦‚æœæ˜¯ç‚¹å‡»å·¥å…·å¡ç‰‡è§¦å‘çš„ï¼Œä½¿ç”¨åŸå§‹é—®é¢˜
            if (selectedTool) {
                text = originalQuery;
            } else {
                if (!text) return;
                appendMessage('user', text);
                userInput.value = '';
            }

            // æ„é€ è¯·æ±‚åŒ…ï¼Œå¸¦ä¸Šå†å²è®°å½•
            const payload = {
                message: text,
                history: chatHistory, 
                selected_tool: selectedTool, 
                uploaded_file_id: currentUploadedFile.id,
                uploaded_file_name: currentUploadedFile.name
            };

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const loadingDiv = appendMessage('system', 'â³ æ€è€ƒä¸­...');

            try {
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                
                // ç§»é™¤åŠ è½½æç¤º
                loadingDiv.remove();

                // å¤„ç†å“åº”
                if (data.type === 'choice') {
                    // æ¸²æŸ“å·¥å…·é€‰æ‹©åˆ—è¡¨
                    let html = `<p>${data.reply}</p>`;
                    data.candidates.forEach((tool, index) => {
                        // è½¬ä¹‰ JSON å­—ç¬¦ä¸²ä»¥æ”¾å…¥ onclick
                        const toolStr = JSON.stringify(tool).replace(/"/g, '&quot;');
                        html += `
                        <div class="tool-card" onclick="selectTool(${toolStr}, '${text}')">
                            <strong>${index + 1}. ${tool.name}</strong><br>
                            <small style="color:#666">${tool.id}</small>
                        </div>`;
                    });
                    appendMessage('system', html);
                } else {
                    // æ™®é€šæ–‡æœ¬æˆ–ä»£ç  (Markdownæ¸²æŸ“)
                    appendMessage('system', marked.parse(data.reply));
                    
                    // æ›´æ–°å†å²è®°å½• (ç®€åŒ–å­˜å‚¨ï¼Œé¿å…å­˜å…¥è¿‡é•¿çš„ HTML)
                    // å°†ä»£ç å—æ›¿æ¢ä¸ºå ä½ç¬¦ï¼ŒèŠ‚çœ Token
                    const simplifiedReply = data.reply.replace(/```[\s\S]*?```/g, '[ä»£ç æ‰§è¡Œç»“æœ]');
                    chatHistory.push({ user: text, ai: simplifiedReply });
                }

            } catch (error) {
                loadingDiv.remove();
                appendMessage('system', `<span style="color:red">è¯·æ±‚å¤±è´¥: ${error}</span>`);
            }
        }

        // --- 3. ç”¨æˆ·ç‚¹å‡»å·¥å…·å¡ç‰‡ ---
        function selectTool(tool, query) {
            appendMessage('user', `æˆ‘é€‰æ‹©è¿è¡Œ: <b>${tool.name}</b>`);
            // å†æ¬¡è°ƒç”¨ sendMessageï¼Œä½†å¸¦ä¸Š selectedTool å‚æ•°
            sendMessage(tool, query);
        }

        // --- è¾…åŠ©å‡½æ•°: æ·»åŠ æ¶ˆæ¯ ---
        function appendMessage(role, htmlContent) {
            const div = document.createElement('div');
            div.className = `message ${role}`;
            div.innerHTML = htmlContent;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
            return div; // è¿”å› div å¼•ç”¨ä»¥ä¾¿åç»­ç§»é™¤ï¼ˆå¦‚åŠ è½½åŠ¨ç”»ï¼‰
        }
    </script>
</body>
</html>
