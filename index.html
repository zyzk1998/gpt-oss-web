<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galaxy ç”Ÿä¿¡æ™ºèƒ½åŠ©æ‰‹</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { background-color: #f4f6f9; height: 100vh; display: flex; flex-direction: column; position: relative; }
        .chat-container { flex: 1; overflow-y: auto; padding: 20px; max-width: 900px; margin: 0 auto; width: 100%; z-index: 1; }
        .message { margin-bottom: 20px; padding: 15px; border-radius: 10px; max-width: 85%; word-wrap: break-word; position: relative; }
        .message.user { background-color: #007bff; color: white; align-self: flex-end; margin-left: auto; }
        .message.system { background-color: white; border: 1px solid #ddd; align-self: flex-start; }
        .suggestion-chips { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .chip { background: #e9ecef; color: #495057; border: 1px solid #ced4da; border-radius: 16px; padding: 5px 12px; font-size: 0.85em; cursor: pointer; transition: 0.2s; }
        .chip:hover { background: #dee2e6; border-color: #adb5bd; }
        .tool-card { border: 1px solid #17a2b8; background: #e3f2fd; padding: 10px; margin: 5px 0; border-radius: 5px; cursor: pointer; transition: 0.2s; }
        .tool-card:hover { background: #d1ecf1; }
        .input-area { background: white; padding: 20px; border-top: 1px solid #ddd; z-index: 2; }
        .input-group { max-width: 900px; margin: 0 auto; }
        #dropOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 123, 255, 0.1); border: 4px dashed #007bff; z-index: 999; display: none; justify-content: center; align-items: center; pointer-events: none; }
        #dropOverlay h2 { color: #007bff; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .status-badge { font-size: 0.85em; padding: 5px 10px; border-radius: 15px; display: none; margin-top: 5px; }
        .badge-file { background-color: #28a745; color: white; }
        pre { background: #2d2d2d; color: #f8f8f2; padding: 10px; border-radius: 5px; overflow-x: auto; }
    </style>
</head>
<body>
    <div id="dropOverlay"><h2>ğŸ“‚ é‡Šæ”¾æ–‡ä»¶ä»¥ä¸Šä¼ </h2></div>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid justify-content-center"><span class="navbar-brand mb-0 h1">ğŸ§¬ Galaxy ç”Ÿä¿¡åˆ†ææ™ºèƒ½åŠ©æ‰‹</span></div>
    </nav>
    <div class="chat-container d-flex flex-column" id="chatBox">
        <!-- ç®€æ´å¼€åœºç™½ -->
        <div class="message system">
            ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ç”Ÿç‰©ä¿¡æ¯åŠ©æ‰‹ã€‚å·²è¿æ¥ Galaxy çŸ¥è¯†åº“ã€‚<br>
            è¯·å‘Šè¯‰æˆ‘ä½ æƒ³åšä»€ä¹ˆï¼Ÿä¾‹å¦‚ï¼š<b>"æŸ¥è¯¢æˆ‘çš„è´¦æˆ·ä¿¡æ¯"</b> æˆ– <b>"åˆ—å‡ºæ‰€æœ‰å¯ç”¨çš„å·¥å…·"</b>ã€‚
        </div>
    </div>
    <div class="input-area">
        <div class="input-group">
            <input type="file" id="fileInput" style="display: none;" onchange="handleFileSelect(this.files)">
            <button class="btn btn-outline-secondary" onclick="document.getElementById('fileInput').click()" title="ä¸Šä¼ æ–‡ä»¶ (æ”¯æŒæ‹–æ‹½/ç²˜è´´)">ğŸ“‚ ä¸Šä¼ </button>
            <input type="text" id="userInput" class="form-control" placeholder="è¾“å…¥éœ€æ±‚ï¼Œæˆ–ç²˜è´´æ–‡ä»¶..." onkeypress="handleEnter(event)">
            <button class="btn btn-primary" onclick="sendMessage()" id="sendBtn">å‘é€</button>
        </div>
        <div class="d-flex justify-content-center"><span id="fileStatus" class="status-badge badge-file"></span></div>
    </div>
    <script>
        const chatBox = document.getElementById('chatBox');
        const userInput = document.getElementById('userInput');
        const dropOverlay = document.getElementById('dropOverlay');
        let chatHistory = []; 
        let currentUploadedFile = { id: null, name: null };

        function handleEnter(e) { if (e.key === 'Enter') sendMessage(); }

        window.addEventListener('dragenter', (e) => { e.preventDefault(); dropOverlay.style.display = 'flex'; });
        window.addEventListener('dragleave', (e) => { e.preventDefault(); if (e.clientX === 0 && e.clientY === 0) dropOverlay.style.display = 'none'; });
        window.addEventListener('dragover', (e) => e.preventDefault());
        window.addEventListener('drop', (e) => { e.preventDefault(); dropOverlay.style.display = 'none'; if (e.dataTransfer.files.length > 0) handleFileSelect(e.dataTransfer.files); });
        window.addEventListener('paste', (e) => { if (e.clipboardData.files.length > 0) { e.preventDefault(); handleFileSelect(e.clipboardData.files); } });

        async function handleFileSelect(files) {
            const file = files[0];
            if (!file) return;
            appendMessage('user', `ğŸ“‚ æ­£åœ¨ä¸Šä¼ : ${file.name} ...`);
            const formData = new FormData();
            formData.append('file', file);
            try {
                const res = await fetch('/api/upload', { method: 'POST', body: formData });
                const data = await res.json();
                if (data.status === 'success') {
                    if (data.type === 'image') {
                        const msgDiv = appendMessage('system', `ğŸ‘ï¸ <b>å›¾ç‰‡è¯†åˆ«ç»“æœï¼š</b><br><blockquote>${data.ocr_text}</blockquote>`);
                        chatHistory.push({ user: "[ä¸Šä¼ äº†å›¾ç‰‡]", ai: data.ocr_text });
                        renderSuggestions(msgDiv, data.suggestions);
                    } else {
                        currentUploadedFile = { id: data.file_id, name: data.file_name };
                        const msgDiv = appendMessage('system', `âœ… æ•°æ®å·²ä¸Šä¼  (ID: ${data.file_id})`);
                        const badge = document.getElementById('fileStatus');
                        badge.style.display = 'inline-block';
                        badge.innerText = `ğŸ“„ å·²å°±ç»ª: ${data.file_name}`;
                        chatHistory.push({ user: "[ä¸Šä¼ äº†æ–‡ä»¶]", ai: `æ–‡ä»¶ ${data.file_name} ä¸Šä¼ æˆåŠŸ` });
                        renderSuggestions(msgDiv, data.suggestions);
                    }
                } else { appendMessage('system', `âŒ é”™è¯¯: ${data.message}`); }
            } catch (e) { appendMessage('system', `âŒ ç½‘ç»œé”™è¯¯: ${e}`); }
            document.getElementById('fileInput').value = ''; 
        }

        async function sendMessage(selectedTool = null, originalQuery = null) {
            let text = userInput.value.trim();
            if (selectedTool) text = originalQuery;
            else if (!text) return;
            if (!selectedTool) { appendMessage('user', text); userInput.value = ''; }
            const loadingDiv = appendMessage('system', 'â³ æ€è€ƒä¸­...');
            const payload = { message: text, history: chatHistory, selected_tool: selectedTool, uploaded_file_id: currentUploadedFile.id, uploaded_file_name: currentUploadedFile.name };
            try {
                const res = await fetch('/api/chat', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const data = await res.json();
                loadingDiv.remove();
                if (data.type === 'choice') {
                    let html = `<p>${data.reply}</p>`;
                    data.candidates.forEach((tool, index) => {
                        const toolStr = JSON.stringify(tool).replace(/"/g, '&quot;');
                        html += `<div class="tool-card" onclick="selectTool(${toolStr}, '${text}')"><strong>${index + 1}. ${tool.name}</strong><br><small style="color:#666">${tool.id}</small></div>`;
                    });
                    appendMessage('system', html);
                } else {
                    const msgDiv = appendMessage('system', marked.parse(data.reply));
                    const simplifiedReply = data.reply.replace(/```[\s\S]*?```/g, '[ä»£ç æ‰§è¡Œç»“æœ]');
                    chatHistory.push({ user: text, ai: simplifiedReply });
                    if (data.suggestions && data.suggestions.length > 0) renderSuggestions(msgDiv, data.suggestions);
                }
            } catch (error) { loadingDiv.remove(); appendMessage('system', `<span style="color:red">è¯·æ±‚å¤±è´¥: ${error}</span>`); }
        }

        function renderSuggestions(parentElement, suggestions) {
            if (!suggestions || suggestions.length === 0) return;
            const chipContainer = document.createElement('div');
            chipContainer.className = 'suggestion-chips';
            suggestions.forEach(text => {
                const chip = document.createElement('div');
                chip.className = 'chip';
                chip.innerText = text;
                chip.onclick = () => { userInput.value = text; sendMessage(); };
                chipContainer.appendChild(chip);
            });
            parentElement.appendChild(chipContainer);
            chatBox.scrollTop = chatBox.scrollHeight;
        }
        function selectTool(tool, query) { appendMessage('user', `æˆ‘é€‰æ‹©è¿è¡Œ: <b>${tool.name}</b>`); sendMessage(tool, query); }
        function appendMessage(role, htmlContent) {
            const div = document.createElement('div');
            div.className = `message ${role}`;
            div.innerHTML = htmlContent;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
            return div;
        }
    </script>
</body>
</html>
