<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galaxy AI Studio</title>
    <!-- å¼•å…¥ Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- å¼•å…¥ Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <!-- å¼•å…¥ Markdown è§£æåº“ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        :root {
            --bg-color: #ffffff;
            --chat-width: 800px;
            --primary-color: #4d6bfe;
            --text-color: #1f1f1f;
            --thought-bg: #f8f9fa;
            --thought-border: #e9ecef;
        }

        body {
            background-color: var(--bg-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            margin: 0;
            overflow: hidden;
            color: var(--text-color);
        }

        /* é¡¶éƒ¨å¯¼èˆª */
        .navbar {
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(10px);
            position: absolute; top: 0; width: 100%; z-index: 10;
            padding: 15px 0;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .brand-logo { font-weight: 600; font-size: 1.1rem; color: #333; display: flex; align-items: center; gap: 8px; }

        /* èŠå¤©åŒºåŸŸ */
        .chat-scroll-area {
            flex: 1;
            overflow-y: auto;
            padding: 80px 20px 200px 20px; /* åº•éƒ¨ç•™å‡ºè¶³å¤Ÿç©ºé—´ç»™è¾“å…¥æ¡† */
            scroll-behavior: smooth;
        }
        .chat-content { max-width: var(--chat-width); margin: 0 auto; }

        /* æ¶ˆæ¯è¡Œæ ·å¼ */
        .message-row { display: flex; margin-bottom: 30px; animation: fadeIn 0.3s ease; }
        .message-row.user { justify-content: flex-end; }
        
        .avatar {
            width: 32px; height: 32px; border-radius: 6px; margin-right: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 18px; flex-shrink: 0; margin-top: 2px;
        }
        .avatar.ai { background: #eef2ff; color: var(--primary-color); }
        
        .message-container { max-width: 100%; flex: 1; min-width: 0; }
        .message-row.user .message-container { flex: initial; max-width: 80%; }

        /* æ°”æ³¡æ ·å¼ */
        .bubble { font-size: 15px; line-height: 1.7; color: #374151; }
        .message-row.user .bubble {
            background-color: #f4f4f4;
            color: #000;
            padding: 10px 16px;
            border-radius: 16px;
            border-bottom-right-radius: 4px;
        }
        
        /* Markdown å†…å®¹æ ·å¼ä¼˜åŒ– */
        .bubble pre { background: #f6f8fa; padding: 12px; border-radius: 6px; overflow-x: auto; }
        .bubble code { color: #d63384; font-size: 0.9em; }
        .bubble pre code { color: inherit; }

        /* =========================================
           ã€DeepSeek é£æ ¼æ·±åº¦æ€è€ƒæ¡†ã€‘
           ========================================= */
        .thought-block {
            margin-bottom: 16px;
            border-radius: 8px;
            background: var(--thought-bg);
            border: 1px solid var(--thought-border);
            overflow: hidden;
        }
        
        .thought-header {
            padding: 10px 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 13px;
            font-weight: 600;
            color: #6b7280;
            background: #fcfcfc;
            user-select: none;
            transition: background 0.2s;
        }
        .thought-header:hover { background: #f0f0f0; }
        
        .thought-title { display: flex; align-items: center; gap: 8px; }
        .thought-icon { color: #8b5cf6; font-size: 14px; } /* ç´«è‰²æ˜Ÿæ˜Ÿ */
        
        .thought-content {
            padding: 14px;
            border-top: 1px solid var(--thought-border);
            background: #ffffff;
            color: #4b5563;
            font-size: 13px;
            line-height: 1.6;
            display: none; /* é»˜è®¤æŠ˜å  */
        }
        .thought-content p { margin-bottom: 6px; }
        
        .thought-arrow { transition: transform 0.3s ease; font-size: 12px; color: #9ca3af; }
        .thought-arrow.open { transform: rotate(180deg); }

        /* å·¥å…·å¡ç‰‡ç½‘æ ¼ */
        .tool-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 10px; margin-top: 10px; }
        .tool-card {
            background: #fff; border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px;
            cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden;
        }
        .tool-card:hover { border-color: var(--primary-color); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .tool-card strong { display: block; font-size: 14px; color: #111827; margin-bottom: 4px; }
        .tool-card small { font-size: 12px; color: #6b7280; word-break: break-all; }

        /* =========================================
           ã€Kimi é£æ ¼è¾“å…¥æ¡† (ç²¾ç®€ç‰ˆ)ã€‘
           ========================================= */
        .input-wrapper {
            position: fixed; bottom: 40px; left: 0; width: 100%;
            display: flex; justify-content: center; padding: 0 20px;
            z-index: 100; pointer-events: none; /* ç‚¹å‡»ç©¿é€ */
        }

        .kimi-box {
            pointer-events: auto;
            width: 100%;
            max-width: var(--chat-width);
            background: #fff;
            border: 1px solid #e6e6e6;
            border-radius: 24px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
            padding: 16px 20px 12px 20px;
            display: flex;
            flex-direction: column;
            transition: box-shadow 0.2s, border-color 0.2s;
            position: relative;
        }

        .kimi-box:focus-within {
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.12);
            border-color: #d0d0d0;
        }

        .input-area {
            width: 100%;
            margin-bottom: 8px;
        }

        .main-input {
            width: 100%;
            border: none;
            outline: none;
            font-size: 16px;
            line-height: 1.5;
            resize: none;
            color: #333;
            background: transparent;
            font-family: inherit;
            height: 24px;
            min-height: 24px;
            max-height: 200px;
            overflow-y: auto; /* å†…éƒ¨æ»šåŠ¨ */
        }
        .main-input::placeholder { color: #aaa; }
        /* ç¦ç”¨çŠ¶æ€ */
        .main-input:disabled { background: transparent; cursor: not-allowed; color: #999; }

        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .toolbar-left { display: flex; gap: 10px; }
        .toolbar-right { display: flex; align-items: center; gap: 8px; }

        .icon-btn {
            width: 32px; height: 32px;
            border-radius: 8px;
            border: none;
            background: transparent;
            color: #666;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
            font-size: 18px;
        }
        .icon-btn:hover { background: #f5f5f5; color: #333; }
        .icon-btn:disabled { cursor: not-allowed; opacity: 0.5; }

        .send-btn {
            width: 36px; height: 36px;
            border-radius: 50%;
            background: #e5e5e5;
            color: #fff;
            border: none;
            display: flex; align-items: center; justify-content: center;
            cursor: not-allowed;
            transition: all 0.2s;
            margin-left: 8px;
        }
        .send-btn.active {
            background: #333; /* æ¿€æ´»æ€é»‘è‰² */
            cursor: pointer;
        }
        .send-btn:disabled {
            background: #e5e5e5;
            cursor: not-allowed;
        }
        .send-btn i { font-size: 18px; }

        .file-chips-area {
            display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px;
        }
        .file-chip {
            background: #f7f7f7; border: 1px solid #eee; border-radius: 6px;
            padding: 4px 10px; font-size: 12px; color: #555;
            display: flex; align-items: center; gap: 6px;
        }

        #dropOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95); z-index: 999;
            display: none; flex-direction: column; justify-content: center; align-items: center;
            color: var(--primary-color);
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="dropOverlay">
        <i class="bi bi-cloud-upload" style="font-size: 48px; margin-bottom: 10px;"></i>
        <h4>é‡Šæ”¾æ–‡ä»¶ä»¥ä¸Šä¼ </h4>
    </div>

    <nav class="navbar">
        <div class="container d-flex justify-content-center">
            <div class="brand-logo"><i class="bi bi-stars" style="color: var(--primary-color);"></i> GPT-OSS Galaxy</div>
        </div>
    </nav>

    <div class="chat-scroll-area" id="chatBox">
        <div class="chat-content" id="chatContent">
            <!-- é€šç”¨å¼€åœºç™½ -->
            <div class="message-row ai">
                <div class="avatar ai"><i class="bi bi-robot"></i></div>
                <div class="message-container">
                    <div class="bubble">
                        <p>ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ <b>Galaxy ç”Ÿä¿¡æ™ºèƒ½åŠ©æ‰‹</b>ã€‚</p>
                        <p>æˆ‘å¯ä»¥å¸®ä½ æŸ¥è¯¢å·¥å…·ã€ä¸Šä¼ æ•°æ®å¹¶ç”Ÿæˆåˆ†æä»£ç ã€‚è¯•ç€é—®æˆ‘ï¼š</p>
                        <ul>
                            <li>"åˆ—å‡ºæ‰€æœ‰ Seurat ç›¸å…³çš„å·¥å…·"</li>
                            <li>"å¦‚ä½•åš RNA-seq å·®å¼‚è¡¨è¾¾åˆ†æï¼Ÿ"</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Kimi é£æ ¼è¾“å…¥æ¡† (ç²¾ç®€ç‰ˆ) -->
    <div class="input-wrapper">
        <div class="kimi-box">
            <div id="filePreviewArea" class="file-chips-area"></div>
            <div class="input-area">
                <textarea id="userInput" class="main-input" placeholder="å°½ç®¡é—®..." rows="1" oninput="autoResize(this); checkInput();" onkeydown="handleEnter(event)"></textarea>
            </div>
            <div class="toolbar">
                <div class="toolbar-left">
                    <!-- å·¦ä¾§ç•™ç©ºï¼Œå»æ‰äº†æ— ç”¨æŒ‰é’® -->
                </div>
                <div class="toolbar-right">
                    <input type="file" id="fileInput" style="display: none;" onchange="handleFileSelect(this.files)" multiple>
                    <button id="uploadBtn" class="icon-btn" onclick="document.getElementById('fileInput').click()" title="ä¸Šä¼ æ–‡ä»¶">
                        <i class="bi bi-paperclip"></i>
                    </button>
                    <button id="sendBtn" class="send-btn" onclick="sendMessage()">
                        <i class="bi bi-arrow-up"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const chatContent = document.getElementById('chatContent');
        const chatScrollArea = document.getElementById('chatBox');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');
        const uploadBtn = document.getElementById('uploadBtn');
        const filePreviewArea = document.getElementById('filePreviewArea');
        const dropOverlay = document.getElementById('dropOverlay');

        let chatHistory = []; 
        let uploadedFiles = []; 
        let isProcessing = false; // çŠ¶æ€é”

        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }

        function checkInput() {
            if (isProcessing) {
                sendBtn.classList.remove('active');
                return;
            }
            if (userInput.value.trim() !== '' || uploadedFiles.length > 0) sendBtn.classList.add('active');
            else sendBtn.classList.remove('active');
        }

        function handleEnter(e) { 
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if (!isProcessing) {
                    sendMessage();
                }
            }
        }

        // ã€æ ¸å¿ƒã€‘åˆ‡æ¢é”å®šçŠ¶æ€
        function toggleLoadingState(isLoading) {
            isProcessing = isLoading;
            userInput.disabled = isLoading;
            uploadBtn.disabled = isLoading;
            
            if (isLoading) {
                sendBtn.disabled = true;
                sendBtn.classList.remove('active');
                userInput.style.cursor = 'wait';
            } else {
                sendBtn.disabled = false;
                userInput.style.cursor = 'text';
                userInput.focus();
                checkInput();
            }
        }

        window.addEventListener('dragenter', (e) => { if(!isProcessing) { e.preventDefault(); dropOverlay.style.display = 'flex'; } });
        window.addEventListener('dragleave', (e) => { e.preventDefault(); if (e.clientX === 0 && e.clientY === 0) dropOverlay.style.display = 'none'; });
        window.addEventListener('dragover', (e) => e.preventDefault());
        window.addEventListener('drop', (e) => { 
            e.preventDefault(); 
            dropOverlay.style.display = 'none'; 
            if (!isProcessing && e.dataTransfer.files.length > 0) handleFileSelect(e.dataTransfer.files); 
        });
        window.addEventListener('paste', (e) => { 
            if (!isProcessing && e.clipboardData.files.length > 0) { 
                e.preventDefault(); 
                handleFileSelect(e.clipboardData.files); 
            } 
        });

        async function handleFileSelect(files) {
            if (files.length === 0) return;
            toggleLoadingState(true);
            for (let i = 0; i < files.length; i++) await uploadSingleFile(files[i]);
            document.getElementById('fileInput').value = ''; 
            toggleLoadingState(false);
        }

        async function uploadSingleFile(file) {
            const tempId = 'temp-' + Date.now();
            addFileTag(file.name, true, tempId);
            const formData = new FormData();
            formData.append('file', file);
            try {
                const res = await fetch('/api/upload', { method: 'POST', body: formData });
                const data = await res.json();
                removeFileTag(tempId);
                if (data.status === 'success') {
                    if (data.type === 'image') {
                        appendMessage('ai', `ğŸ‘ï¸ <b>å›¾ç‰‡è¯†åˆ«ç»“æœï¼š</b><br><blockquote>${data.ocr_text}</blockquote>`);
                        chatHistory.push({ user: "[ä¸Šä¼ äº†å›¾ç‰‡]", ai: data.ocr_text });
                    } else {
                        uploadedFiles.push({ id: data.file_id, name: data.file_name });
                        renderFileTags();
                    }
                } else alert(`ä¸Šä¼ å¤±è´¥: ${data.message}`);
            } catch (e) { removeFileTag(tempId); alert(`ç½‘ç»œé”™è¯¯: ${e}`); }
        }

        function renderFileTags() {
            filePreviewArea.innerHTML = '';
            uploadedFiles.forEach((f, index) => {
                const div = document.createElement('div');
                div.className = 'file-chip';
                div.innerHTML = `<i class="bi bi-file-earmark-text"></i><span>${f.name}</span><i class="bi bi-x" style="cursor:pointer" onclick="removeFile(${index})"></i>`;
                filePreviewArea.appendChild(div);
            });
        }
        function addFileTag(name, isLoading, tempId) {
            const div = document.createElement('div');
            div.className = 'file-chip'; div.id = tempId;
            div.innerHTML = `<i class="bi bi-${isLoading ? 'hourglass-split' : 'file-earmark-text'}"></i><span>${name} ${isLoading ? '(ä¸Šä¼ ä¸­...)' : ''}</span>`;
            filePreviewArea.appendChild(div);
        }
        function removeFileTag(id) { const el = document.getElementById(id); if (el) el.remove(); }
        function removeFile(index) { 
            if(!isProcessing) {
                uploadedFiles.splice(index, 1); renderFileTags(); checkInput(); 
            }
        }

        async function sendMessage(selectedTool = null, originalQuery = null) {
            if (isProcessing) return;

            let text = userInput.value.trim();
            if (selectedTool) text = originalQuery;
            else if (!text && uploadedFiles.length === 0) return;

            if (!selectedTool) {
                appendMessage('user', text || `[å‘é€äº† ${uploadedFiles.length} ä¸ªæ–‡ä»¶]`);
                userInput.value = '';
                userInput.style.height = '24px'; 
            }

            toggleLoadingState(true);

            const loadingId = 'loading-' + Date.now();
            appendLoadingMessage(loadingId);
            const startTime = Date.now();

            const payload = { 
                message: text, 
                history: chatHistory, 
                selected_tool: selectedTool, 
                uploaded_files: uploadedFiles 
            };
            
            try {
                const res = await fetch('/api/chat', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify(payload) 
                });
                
                if (!res.ok) {
                    const errorText = await res.text();
                    throw new Error(errorText || res.statusText);
                }

                const data = await res.json();
                
                document.getElementById(loadingId).remove();
                const duration = ((Date.now() - startTime) / 1000).toFixed(1);

                if (data.type === 'choice') {
                    let html = `<p>${data.reply}</p><div class="tool-grid">`;
                    data.candidates.forEach((tool, index) => {
                        const name = tool.name || "Unknown Tool";
                        const id = tool.id || ""; 
                        const toolStr = JSON.stringify(tool).replace(/"/g, '&quot;');
                        const idHtml = id ? `<small style="color:#666">${id}</small>` : '';
                        html += `
                        <div class="tool-card" onclick="selectTool(${toolStr}, '${text}')">
                            <i class="bi bi-box-seam" style="position:absolute; right:-5px; bottom:-5px; font-size:50px; opacity:0.05;"></i>
                            <strong>${index + 1}. ${name}</strong>
                            ${idHtml}
                        </div>`;
                    });
                    html += `</div>`;
                    appendMessage('ai', html, data.thought, duration);
                } else {
                    const msgDiv = appendMessage('ai', marked.parse(data.reply), data.thought ? marked.parse(data.thought) : null, duration);
                    const simplifiedReply = data.reply.replace(/```[\s\S]*?```/g, '[ä»£ç æ‰§è¡Œç»“æœ]');
                    chatHistory.push({ user: text, ai: simplifiedReply });
                    if (data.suggestions && data.suggestions.length > 0) renderSuggestions(msgDiv, data.suggestions);
                }
            } catch (error) {
                document.getElementById(loadingId).remove();
                appendMessage('ai', `<span style="color:red">è¯·æ±‚å¤±è´¥: ${error}</span>`);
            } finally {
                toggleLoadingState(false);
            }
        }

        function appendMessage(role, htmlContent, thoughtContent = null, duration = null) {
            const row = document.createElement('div');
            row.className = `message-row ${role}`;
            
            let avatarHtml = role === 'ai' ? `<div class="avatar ai"><i class="bi bi-robot"></i></div>` : '';
            
            let thoughtHtml = '';
            if (role === 'ai' && thoughtContent) {
                thoughtHtml = `
                <div class="thought-block">
                    <div class="thought-header" onclick="toggleThought(this)">
                        <div class="thought-title"><i class="bi bi-stars thought-icon"></i> æ·±åº¦æ€è€ƒ</div>
                        <i class="bi bi-chevron-down thought-arrow"></i>
                    </div>
                    <div class="thought-content">${thoughtContent}</div>
                </div>`;
            }

            let footerHtml = '';
            if (role === 'ai' && duration) {
                footerHtml = `<div style="margin-top:5px; font-size:12px; color:#999; display:flex; gap:10px;"><span>${duration}s</span><i class="bi bi-copy" style="cursor:pointer" onclick="copyText(this)"></i></div>`;
            }

            row.innerHTML = `
                ${role === 'ai' ? avatarHtml : ''}
                <div class="message-container">
                    ${thoughtHtml}
                    <div class="bubble">${htmlContent}</div>
                    ${footerHtml}
                </div>
            `;
            
            chatContent.appendChild(row);
            scrollToBottom();
            return row.querySelector('.bubble');
        }

        function toggleThought(header) {
            const content = header.nextElementSibling;
            const arrow = header.querySelector('.thought-arrow');
            if (content.style.display === 'block') {
                content.style.display = 'none';
                arrow.classList.remove('open');
            } else {
                content.style.display = 'block';
                arrow.classList.add('open');
            }
        }

        // ã€å…¼å®¹æ€§ä¿®å¤ã€‘å¤åˆ¶åŠŸèƒ½
        function copyText(btn) {
            const text = btn.closest('.message-container').querySelector('.bubble').innerText;
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text).then(() => showCopyFeedback(btn));
            } else {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = "fixed";
                textArea.style.left = "-9999px";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    showCopyFeedback(btn);
                } catch (err) { console.error(err); }
                document.body.removeChild(textArea);
            }
        }

        function showCopyFeedback(btn) {
            const icon = btn;
            icon.className = 'bi bi-check';
            setTimeout(() => icon.className = 'bi bi-copy', 2000);
        }

        function appendLoadingMessage(id) {
            const row = document.createElement('div');
            row.className = `message-row ai`; row.id = id;
            row.innerHTML = `<div class="avatar ai"><i class="bi bi-robot"></i></div><div class="message-container"><div class="bubble"><div class="spinner-border spinner-border-sm text-primary" role="status"></div><span style="margin-left:8px; color:#666;">æ€è€ƒä¸­...</span></div></div>`;
            chatContent.appendChild(row);
            scrollToBottom();
        }

        function renderSuggestions(parentElement, suggestions) {
            if (!suggestions || suggestions.length === 0) return;
            const div = document.createElement('div');
            div.style.marginTop = "10px"; div.style.display = "flex"; div.style.gap = "8px"; div.style.flexWrap = "wrap";
            suggestions.forEach(text => {
                const chip = document.createElement('div');
                chip.className = 'file-chip';
                chip.style.cursor = "pointer"; chip.style.background = "white";
                chip.innerText = text;
                chip.onclick = () => { userInput.value = text; sendMessage(); };
                div.appendChild(chip);
            });
            parentElement.parentNode.appendChild(div);
            scrollToBottom();
        }

        function selectTool(tool, query) { appendMessage('user', `æˆ‘é€‰æ‹©è¿è¡Œ: <b>${tool.name}</b>`); sendMessage(tool, query); }
        function scrollToBottom() { chatScrollArea.scrollTop = chatScrollArea.scrollHeight; }
    </script>
</body>
</html>
