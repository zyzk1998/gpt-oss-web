import json
import os
import shutil
from langchain_ollama import OllamaEmbeddings
from langchain_chroma import Chroma
from langchain_core.documents import Document
from dotenv import load_dotenv

# åŠ è½½ç¯å¢ƒå˜é‡
load_dotenv()

# ================= é…ç½®åŒºåŸŸ =================
# å¿…é¡»å’Œä½ çš„ app.py é‡Œçš„é…ç½®ä¿æŒä¸€è‡´
JSON_PATH = "data/bioblend_knowledge.json"
DB_PATH = "data/chroma_db_bioblend"
EMBED_MODEL = "nomic-embed-text"  # ç¡®ä¿ä½  Ollama é‡Œè£…äº†è¿™ä¸ªæ¨¡å‹
OLLAMA_URL = "http://localhost:11434"
# ===========================================

def rebuild():
    print(f"ğŸš€ å¼€å§‹é‡å»ºçŸ¥è¯†åº“...")

    # 1. æš´åŠ›æ¸…ç†æ—§æ•°æ® (ç›¸å½“äºæ ¼å¼åŒ–å¤§è„‘)
    if os.path.exists(DB_PATH):
        print(f"ğŸ—‘ï¸  æ­£åœ¨åˆ é™¤æ—§çš„å‘é‡æ•°æ®åº“: {DB_PATH}")
        shutil.rmtree(DB_PATH)
    else:
        print(f"âœ¨ æœªå‘ç°æ—§æ•°æ®åº“ï¼Œå‡†å¤‡æ–°å»º...")

    # 2. è¯»å– JSON æ–‡ä»¶ (åŸæ–™)
    if not os.path.exists(JSON_PATH):
        print(f"âŒ é”™è¯¯ï¼šæ‰¾ä¸åˆ° {JSON_PATH}ï¼è¯·å…ˆè¿è¡Œ extract_rules.py")
        return

    print(f"ğŸ“– æ­£åœ¨è¯»å–è§„åˆ™æ–‡ä»¶: {JSON_PATH} ...")
    with open(JSON_PATH, "r", encoding="utf-8") as f:
        data = json.load(f)

    # 3. è½¬æ¢æ ¼å¼
    documents = []
    for item in data:
        # å°† JSON çš„å„ä¸ªå­—æ®µæ‹¼æˆä¸€æ®µå®Œæ•´çš„æ–‡æœ¬ï¼Œæ–¹ä¾¿ AI ç†è§£
        # è¿™é‡Œçš„ text_for_vector_db æ˜¯æˆ‘ä»¬åœ¨ extract_rules.py é‡Œç²¾å¿ƒæ„é€ çš„
        content = item.get("text_for_vector_db", "")
        if not content:
            # å¦‚æœæ²¡æœ‰é¢„å¤„ç†å¥½çš„æ–‡æœ¬ï¼Œå°±å…œåº•ç”¨ description
            content = f"API: {item.get('api_call')}\nDesc: {item.get('description')}"
            
        doc = Document(
            page_content=content,
            metadata={"api_call": item.get("api_call", "unknown")}
        )
        documents.append(doc)

    print(f"ğŸ§© å…±åŠ è½½äº† {len(documents)} æ¡è§„åˆ™ã€‚")

    # 4. å‘é‡åŒ–å¹¶å­˜å‚¨ (è¿™ä¸€æ­¥æœ€æ…¢ï¼Œéœ€è¦è°ƒç”¨ Ollama)
    print(f"ğŸ§  æ­£åœ¨è°ƒç”¨ Ollama ({EMBED_MODEL}) è¿›è¡Œå‘é‡åŒ–å†™å…¥ï¼Œè¯·è€å¿ƒç­‰å¾…...")
    
    try:
        embeddings = OllamaEmbeddings(model=EMBED_MODEL, base_url=OLLAMA_URL)
        Chroma.from_documents(documents, embeddings, persist_directory=DB_PATH)
        print(f"âœ… æˆåŠŸï¼çŸ¥è¯†åº“å·²é‡å»ºå®Œæˆã€‚")
        print(f"ğŸ“‚ æ•°æ®ä¿å­˜åœ¨: {DB_PATH}")
    except Exception as e:
        print(f"âŒ å‘é‡åŒ–å¤±è´¥: {e}")
        print("è¯·æ£€æŸ¥ï¼š1. Ollama æ˜¯å¦å¯åŠ¨ï¼Ÿ 2. æ˜¯å¦å®‰è£…äº† nomic-embed-text æ¨¡å‹ï¼Ÿ")

if __name__ == "__main__":
    rebuild()
